// -------------------------------------------------------------------
// Libraries
// -------------------------------------------------------------------
#include <Adafruit_GFX.h>        
#include <Adafruit_SSD1306.h>    
#include <Wire.h>                
#include "MAX30105.h"            
#include "heartRate.h"           

// -------------------------------------------------------------------
// Objects & Definitions
// -------------------------------------------------------------------
MAX30105 particleSensor;

const byte RATE_SIZE = 4;        
byte rates[RATE_SIZE];           
byte rateSpot = 0;
long lastBeat = 0;               
float beatsPerMinute;
int beatAvg;

#define BeatBuzzer 3
#define LMaHeartBuzzer 2
#define LM35 A0

#define SCREEN_WIDTH 128         
#define SCREEN_HEIGHT 64         
#define OLED_RESET    -1         

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// -------------------------------------------------------------------
// Bitmaps
// -------------------------------------------------------------------
const unsigned char epd_bitmap_black_heartbeat_icon_vector_illustration_260nw_2428187237_ezgif [] PROGMEM = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 
	0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x40, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x60, 0x00, 0x40, 0x00, 0x00, 0x0c, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x60, 0x00, 0x40, 0x00, 0x00, 0x0c, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0xc0, 
	0x00, 0x00, 0x04, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0xc0, 0x00, 0x00, 0x14, 
	0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x80, 0x00, 0x00, 0x10, 0x00, 0x18, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x92, 0x00, 0x80, 0x00, 0x00, 0x10, 0x40, 0x18, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x12, 0x00, 0x80, 0x00, 0x00, 0x10, 0x40, 0x10, 0x00, 0x00, 0x00, 0x00, 0x01, 0x12, 0x00, 
	0x20, 0x00, 0x00, 0x22, 0x40, 0x04, 0x00, 0x00, 0x00, 0x00, 0x01, 0x12, 0x00, 0x20, 0x00, 0x00, 
	0x22, 0x60, 0x04, 0x00, 0x00, 0x00, 0x00, 0x01, 0x13, 0x01, 0x20, 0x40, 0x00, 0x22, 0x60, 0x24, 
	0x88, 0x00, 0x00, 0x00, 0x01, 0x13, 0x01, 0x24, 0x60, 0x00, 0x22, 0x20, 0x24, 0x8c, 0x00, 0x00, 
	0x00, 0x02, 0x13, 0x01, 0x26, 0x10, 0x00, 0x42, 0x20, 0x24, 0x83, 0xff, 0x80, 0x00, 0x00, 0x05, 
	0x60, 0x26, 0x80, 0x00, 0x02, 0x28, 0x05, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x80, 0x1a, 0x80, 
	0x00, 0x02, 0x90, 0x05, 0x50, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x19, 0x00, 0x00, 0x02, 0x80, 
	0x01, 0x60, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x19, 0x00, 0x00, 0x00, 0x80, 0x02, 0x60, 0x00, 
	0x00, 0x00, 0x00, 0x0c, 0x00, 0x19, 0x00, 0x00, 0x01, 0x80, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x0c, 0x00, 0x10, 0x00, 0x00, 0x01, 0x80, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 
	0x00, 0x00, 0x01, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x01, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

const int epd_bitmap_allArray_LEN = 1;
const unsigned char* epd_bitmap_allArray[1] = {
    epd_bitmap_black_heartbeat_icon_vector_illustration_260nw_2428187237_ezgif
};

static const unsigned char PROGMEM image_heart_bits[] = {
    0x38,0x38,0x6c,0x6c,0x46,0xc4,0xc3,0x86,
    0x81,0x02,0x80,0x02,0x80,0x02,0xc0,0x06,
    0x40,0x04,0x60,0x0c,0x20,0x08,0x30,0x18,
    0x18,0x30,0x0c,0x60,0x06,0xc0,0x03,0x80
};

static const unsigned char PROGMEM image_Layer_8_bits[] = { 0x80 };

static const unsigned char PROGMEM image_weather_temperature_bits[] = {
    0x1c,0x00,0x22,0x02,0x2b,0x05,0x2a,0x02,
    0x2b,0x38,0x2a,0x60,0x2b,0x40,0x2a,0x40,
    0x2a,0x60,0x49,0x38,0x9c,0x80,0xae,0x80,
    0xbe,0x80,0x9c,0x80,0x41,0x00,0x3e,0x00
};

// -------------------------------------------------------------------
// Setup
// -------------------------------------------------------------------
void setup() {

  Wire.setClock(400000);
  display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
  display.setTextColor(WHITE);

  // MAX30102 Setup
  particleSensor.begin(Wire, I2C_SPEED_FAST);
  particleSensor.setup();
  particleSensor.setPulseAmplitudeRed(0x0F);

  // Welcome Screen
  display.clearDisplay();
  display.setTextColor(1);
  display.setTextWrap(false);
  display.setCursor(35, 19);
  display.print("Welcome To");
  display.setCursor(5, 29);
  display.print("BioSync Monitor V1.0");
  display.drawBitmap(15, 38, epd_bitmap_black_heartbeat_icon_vector_illustration_260nw_2428187237_ezgif, 100, 30, 1);
  display.display();
  delay(7000);

  // Author Screen
  display.clearDisplay();
  display.setCursor(59, 20);
  display.print("By");
  display.setCursor(8, 33);
  display.print("Eng. Yousef Elasfer");
  display.display();
  delay(4000);

  pinMode(BeatBuzzer, OUTPUT);
  pinMode(LMaHeartBuzzer, OUTPUT);
  pinMode(LM35, INPUT);
}

// -------------------------------------------------------------------
// Main Loop
// -------------------------------------------------------------------
void loop() {

  int Vout = analogRead(LM35);
  int temp = Vout * 500 / 1023;

  long irValue = particleSensor.getIR();

  if (irValue > 50000) {

    if (checkForBeat(irValue) == true) {

      long delta = millis() - lastBeat;
      lastBeat = millis();
      beatsPerMinute = 60 / (delta / 1000.0);

      if (beatsPerMinute < 255 && beatsPerMinute > 20) {

        rates[rateSpot++] = (byte)beatsPerMinute;
        rateSpot %= RATE_SIZE;

        beatAvg = 0;
        for (byte x = 0; x < RATE_SIZE; x++)
          beatAvg += rates[x];
        beatAvg /= RATE_SIZE;

        // Display BPM & Temperature
        display.clearDisplay();
        display.setTextColor(1);
        display.setTextSize(2);
        display.setTextWrap(false);

        display.setCursor(33, 12);
        display.print("BPM:");
        display.setCursor(88, 12);
        display.print(beatAvg);
        display.drawBitmap(10, 11, image_heart_bits, 15, 16, 1);

        display.drawBitmap(10, 36, image_weather_temperature_bits, 16, 16, 1);
        display.setCursor(33, 37);
        display.print("BBT:");
        display.setCursor(88, 37);
        display.print(temp);
        display.setCursor(116, 37);
        display.print("C");
        display.drawBitmap(115, 35, image_Layer_8_bits, 1, 1, 1);

        display.display();

        tone(BeatBuzzer, 1000);
        delay(100);
        noTone(BeatBuzzer);
      }
    }

  } else {

    display.clearDisplay();
    display.setTextColor(1);
    display.setTextSize(1);
    display.setTextWrap(false);

    display.setCursor(0, 14);
    display.print("Place your finger");
    display.setCursor(0, 23);
    display.print("in sensor and wait..");
    display.display();
  }

  if (temp > 37 || beatAvg > 100) {
    digitalWrite(LMaHeartBuzzer, HIGH);
  } else {
    digitalWrite(LMaHeartBuzzer, LOW);
  }
}
